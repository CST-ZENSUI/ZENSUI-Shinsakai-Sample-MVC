@model ZENSUI_SINSAKAI.Models.Syuppin

@{
    ViewData["Title"] = "Syousai";
}

<div id="my-main">
    <table id="my-table">
        <tr class="tr-title tr-border-none">
            <td class="td-row-no" style="width: 11%; height: 40px">#@Model.RowNo</td>
            <td colspan="4" style="width: 44%">@Model.Title1</td>
            <td colspan="4" style="width: 44%">@Model.Title2</td>
        </tr>
        <tr class="tr-border-none">
            <td colspan="9" class="td-color1" style="height: 4px;"></td>
        </tr>
        <tr class="tr-border-none">
            <td colspan="3" style="width: 33%; height: 210px;">
                <img class="my-image" src="@Model.Image1" alt="" />
            </td>
            <td colspan="3" style="width: 33%; height: 210px;">
                <img class="my-image" src="@Model.Image2" alt="" />
            </td>
            <td colspan="3" style="width: 33%; height: 210px;">
                <img class="my-image" src="@Model.Image3" alt="" />
            </td>
        </tr>
        <tr>
            <td class="td-color2 td-item-name" style="width: 11%; height: 32px">製品区分</td>
            <td style="width: 11%">@Model.SeihinKubun</td>
            <td class="td-color2 td-item-name" style="width: 11%">出品区分</td>
            <td style="width: 11%">@Model.SyuppinKubun</td>
            <td class="td-color2 td-item-name" style="width: 11%">受賞歴</td>
            <td colspan="4" style="width: 44%">@Model.Zyusyoureki</td>
        </tr>
        <tr>
            <td class="td-color2 td-item-name" style="width: 11%; height: 32px">販売開始時期</td>
            <td class="td-hanbai-kaisiziki" style="width: 11%">@Model.HanbaiKaisiziki</td>
            <td class="td-color2 td-item-name" style="width: 11%">販売区分</td>
            <td style="width: 11%">@Model.HanbaiKubun</td>
            <td class="td-color2 td-item-name" style="width: 11%">販売先</td>
            <td colspan="4" style="width: 44%">@Model.Hanbaisaki</td>
        </tr>
        <tr>
            <td class="td-color2 td-item-name" style="width: 11%; height: 100px">使用原材料<br />（一括表示）</td>
            <td colspan="8" style="width: 88%">@Model.SiyouGenzairyou</td>
        </tr>
        <tr>
            <td class="td-color2 td-item-name" style="width: 11%; height: 32px">アレルギー表示<br />（特定８品目）</td>
            <td colspan="3" style="width: 33%">@Model.AllergyHyouzi</td>
            <td class="td-color2 td-item-name" style="width: 11%">原料（原産地）</td>
            <td colspan="4" style="width: 44%">@Model.Gensanti</td>
        </tr>
        <tr>
            <td class="td-color2 td-item-name" style="width: 11%; height: 32px">標準小売価格</td>
            <td colspan="3" style="width: 33%">@Model.HyouzyunKouriKakaku</td>
            <td class="td-color2 td-item-name" style="width: 11%">1個あたり重量</td>
            <td colspan="4" style="width: 44%">@Model.IkkoatariZyuuryou</td>
        </tr>
        <tr>
            <td class="td-color2 td-item-name" style="width: 11%; height: 32px">保存条件</td>
            <td colspan="3" style="width: 33%">@Model.HozonZyouken</td>
            <td class="td-color2 td-item-name" style="width: 11%">賞味期限</td>
            <td colspan="4" style="width: 44%">@Model.SyoumiKigen</td>
        </tr>
        <tr>
            <td class="td-color2 td-item-name" style="width: 11%; height: 50px">食べ方・<br />アレンジ</td>
            <td colspan="8" style="width: 88%">@Model.Tabekata</td>
        </tr>
        <tr class="tr-border-none">
            <td colspan="9" style="height: 10px;"></td>
        </tr>
        <tr>
            <td class="td-color3 td-item-name" style="width: 11%; height: 50px">商品特徴・<br />アピールポイント<br />について</td>
            <td colspan="8" style="width: 88%">@Model.SyouhinTokutyou</td>
        </tr>
        <tr>
            <td class="td-color3 td-item-name" style="width: 11%; height: 50px">官能特性について<br />（味、食感等）</td>
            <td colspan="8" style="width: 88%">@Model.KannouTokusei</td>
        </tr>
        <tr>
            <td class="td-color3 td-item-name" style="width: 11%; height: 50px">着想について<br />（エピソード、<br />コンセプト等）</td>
            <td colspan="8" style="width: 88%">@Model.Tyakusou</td>
        </tr>
        <tr>
            <td class="td-color3 td-item-name" style="width: 11%; height: 50px">原料について</td>
            <td colspan="8" style="width: 88%">@Model.Genryou</td>
        </tr>
        <tr>
            <td class="td-color3 td-item-name" style="width: 11%; height: 50px">生産技術について</td>
            <td colspan="8" style="width: 88%">@Model.SeisanGizyutu</td>
        </tr>
        <tr>
            <td class="td-color3 td-item-name" style="width: 11%; height: 50px">その他（地域貢<br />献、ＣＳＲ、<br />ＳＤＧｓ等の取組）</td>
            <td colspan="8" style="width: 88%">@Model.Sonota</td>
        </tr>
        <tr class="tr-border-none">
            <td colspan="9" style="height: 10px;"></td>
        </tr>
        <tr class="tr-border-none tr-score">
            <td class="td-color1 td-item-name" style="width: 11%; height: 20px">官能特性</td>
            <td class="td-color1 td-item-name" style="width: 11%">着　想</td>
            <td class="td-color1 td-item-name" style="width: 11%">原　料</td>
            <td class="td-color1 td-item-name" style="width: 11%">技　術</td>
            <td class="td-color1 td-item-name" style="width: 11%">包　装</td>
            <td class="td-color1 td-item-name" colspan="3" style="width: 33%">合　計</td>
            <th class="td-color1 td-item-name" style="width: 11%">マーク</th>
        </tr>
        <tr class="tr-border-none tr-score">
            <td style="width: 11%; height: 50px"></td>
            <td style="width: 11%"></td>
            <td style="width: 11%"></td>
            <td style="width: 11%"></td>
            <td style="width: 11%"></td>
            <td colspan="3" style="width: 33%"></td>
            <th style="width: 11%"></th>
        </tr>
        <tr class="tr-border-none tr-score">
            <td class="td-max-score" style="width: 11%; height: 20px">／３０点</td>
            <td class="td-max-score" style="width: 11%">／２０点</td>
            <td class="td-max-score" style="width: 11%">／１０点</td>
            <td class="td-max-score" style="width: 11%">／２０点</td>
            <td class="td-max-score" style="width: 11%">／２０点</td>
            <td class="td-max-score" colspan="3" style="width: 33%">／１００点</td>
            <th class="td-max-score" style="width: 11%"></th>
        </tr>
        <tr class="tr-border-none">
            <td colspan="9" style="height: 6px;"></td>
        </tr>
        <tr class="tr-border-none">
            <td colspan="9" class="td-color1 td-item-name" style="width: 99%; height: 20px">特記事項</td>
        </tr>
        <tr class="tr-border-none">
            <td class="td-tokki-zikou" colspan="9" style="width: 99%; height: 100px">@Model.TokkiZikou</td>
        </tr>
    </table>
    <span id="layerd-canvas-area">
        <canvas id="draw-area" width="980" height="1100" style="touch-action: pinch-zoom; border:none;"></canvas>
        <canvas id="line-width-indicator" width="980" height="1100" style="touch-action: pinch-zoom; border:none;"></canvas>
    </span>
    <div id="my-score">
        <input type="text" id="score-kannou-tokusei" class="text-score" onclick="textScoreClick(ModalTarget.KANNOU_TOKUSEI, 31)" readonly /><!--
     --><input type="text" id="score-tyakusou" class="text-score" onclick="textScoreClick(ModalTarget.TYAKUSOU, 21)" readonly /><!--
     --><input type="text" id="score-genryou" class="text-score" onclick="textScoreClick(ModalTarget.GENRYOU, 11)" readonly /><!--
     --><input type="text" id="score-gizyutu" class="text-score" onclick="textScoreClick(ModalTarget.GIZYUTU, 21)" readonly /><!--
     --><input type="text" id="score-housou" class="text-score" onclick="textScoreClick(ModalTarget.HOUSOU, 21)" readonly /><!--
     --><input type="text" id="score-total" class="text-score-total" readonly />
    </div>
</div>
<br />
<div id="my-action">
    <input id="modoruButton" type="button" value="戻る" onclick="modoruClick()" />
    <label>
        <input type="radio" name="inputType" value="1" checked />ペン入力
    </label>
    <label>
        <input type="radio" name="inputType" value="2" />消しゴム（小）
    </label>
    <label>
        <input type="radio" name="inputType" value="3" />消しゴム（大）
    </label>
    <input id="clearButton" type="button" value="内容をクリア" onclick="clearClick()" />
    <input id="inputModeButton" type="button" value="手書き可" onclick="changeInputMode()" />
</div>

<div id="my-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 id="modal-title"></h5>
            <span class="modal-close" onclick="modalCloseClick()">×</span>
        </div>
        <div id="my-modal-body" class="modal-body">
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        window.addEventListener('DOMContentLoaded', () => {
            inputMode = false;
            inputType = document.getElementsByName("inputType");
            layeredCanvasArea = document.getElementById("layerd-canvas-area");

            myCanvas = document.getElementById("draw-area");
            context = myCanvas.getContext('2d');

            myCanvasForWidthIndicator = document.getElementById("line-width-indicator");
            contextForWidthIndicator = myCanvasForWidthIndicator.getContext('2d');

            layeredCanvasArea.addEventListener('pointermove', pointerMove);
            layeredCanvasArea.addEventListener('pointerleave', pointerLeave);
            layeredCanvasArea.addEventListener('mouseup', mouseUp);
            layeredCanvasArea.addEventListener('touchend', mouseUp);

            image = new Image();
            image.addEventListener('load', drawImageOnCanvas);

            scoreGenryou = document.getElementById('score-genryou');
            scoreKannouTokusei = document.getElementById('score-kannou-tokusei');
            scoreTyakusou = document.getElementById('score-tyakusou');
            scoreGizyutu = document.getElementById('score-gizyutu');
            scoreHousou = document.getElementById('score-housou');
            scoreTotal = document.getElementById('score-total');

            modal = document.getElementById('my-modal');
            modalTitle = document.getElementById('modal-title');
            modalBody = document.getElementById('my-modal-body');

            modalBody.addEventListener('click', selectScore);

            changeInputMode()

            readImage();
            getScore();
        });

        function drawImageOnCanvas() {
            context.clearRect(0, 0, myCanvas.clientWidth, myCanvas.clientHeight);
            context.drawImage(image, 0, 0);
        }

        function pointerMove(e) {
            if (inputMode) {
                let checkValue = '';
                for (let i = 0; i < inputType.length; i++) {
                    if (inputType.item(i).checked) {
                        checkValue = inputType.item(i).value;
                    }
                }

                let currentLineWidth = 1;
                if (checkValue === '1') {
                    context.globalCompositeOperation = "source-over";
                    currentLineWidth = 1;
                    context.strokeStyle = 'red';
                } else {
                    context.globalCompositeOperation = "destination-out";

                    if (checkValue === '2') {
                        currentLineWidth = 20;
                    } else {
                        currentLineWidth = 40;
                    }

                    contextForWidthIndicator.lineCap = 'round';
                    contextForWidthIndicator.lineJoin = 'round';
                    contextForWidthIndicator.lineWidth = 1;
                    contextForWidthIndicator.clearRect(0, 0, myCanvas.clientWidth, myCanvas.clientHeight);
                    contextForWidthIndicator.beginPath();
                    contextForWidthIndicator.arc(e.offsetX, e.offsetY, currentLineWidth / 2, 0, 2 * Math.PI);
                    contextForWidthIndicator.stroke();
                }

                if (e.buttons) {
                    context.lineCap = 'round';
                    context.lineJoin = 'round';
                    context.lineWidth = currentLineWidth;
                    context.beginPath()
                    context.moveTo(e.offsetX - e.movementX, e.offsetY - e.movementY)
                    context.lineTo(e.offsetX, e.offsetY)
                    context.stroke()
                    this.setPointerCapture(e.pointerId)
                }
            }
        }

        function pointerLeave() {
            contextForWidthIndicator.clearRect(0, 0, myCanvas.clientWidth, myCanvas.clientHeight);
        }

        function mouseUp() {
            contextForWidthIndicator.clearRect(0, 0, myCanvas.clientWidth, myCanvas.clientHeight);
            uploadImage();
        }

        function textScoreClick(title, scoreNum) {
            modalTitle.textContent = title + 'の入力';
            modalTarget = title;

            for (let i = 0; i < scoreNum; i++){
                const scoreButton = document.createElement('input');
                scoreButton.classList.add('score-button');
                scoreButton.type = 'button';
                scoreButton.value = i;
                modalBody.appendChild(scoreButton);
            }

            const clearButton = document.createElement('input');
            clearButton.classList.add('clear-button');
            clearButton.type = 'button';
            clearButton.value = 'クリア';
            modalBody.appendChild(clearButton);

            modal.style.display = 'block';
        }

        function selectScore(event) {
            if (event.target !== event.currentTarget) {
                const score = isNaN(event.target.defaultValue) ? '' : event.target.defaultValue;

                switch (modalTarget) {
                    case ModalTarget.GENRYOU:
                        scoreGenryou.value = score;
                        break;
                    case ModalTarget.KANNOU_TOKUSEI:
                        scoreKannouTokusei.value = score;
                        break;
                    case ModalTarget.TYAKUSOU:
                        scoreTyakusou.value = score;
                        break;
                    case ModalTarget.GIZYUTU:
                        scoreGizyutu.value = score;
                        break;
                    case ModalTarget.HOUSOU:
                        scoreHousou.value = score;
                        break;
                }

                if (!scoreGenryou.value && !scoreKannouTokusei.value && !scoreTyakusou.value && !scoreGizyutu.value && !scoreHousou.value) {
                    scoreTotal.value = '';
                }
                else {
                    scoreTotal.value = Number(scoreGenryou.value) + Number(scoreKannouTokusei.value) + Number(scoreTyakusou.value) + Number(scoreGizyutu.value) + Number(scoreHousou.value);
                }

                registScore(scoreGenryou.value, scoreKannouTokusei.value, scoreTyakusou.value, scoreGizyutu.value, scoreHousou.value);

                modalClose();
            }
        }

        function modalCloseClick() {
            modalClose();
        }

        function modalClose() {
            modal.style.display = 'none';

            while (modalBody.firstChild){
                modalBody.removeChild(modalBody.firstChild);
            }
        }

        function modoruClick() {
            window.location.replace("/Home");
        }

        function clearClick() {
            context.clearRect(0, 0, myCanvas.clientWidth, myCanvas.clientHeight);
            scoreGenryou.value = '';
            scoreKannouTokusei.value = '';
            scoreTyakusou.value = '';
            scoreGizyutu.value = '';
            scoreHousou.value = '';
            scoreTotal.value = '';

            uploadImage();
            registScore();
        }

        function changeInputMode() {
            const inputModeButton = document.getElementById("inputModeButton");

            if (inputMode) {
                inputMode = false;
                inputModeButton.value = '手書き不可';
                layeredCanvasArea.removeEventListener('touchend', changeTouchend);
            }
            else {
                inputMode = true;
                inputModeButton.value = '手書き可';
                layeredCanvasArea.addEventListener('touchend', changeTouchend);
            }

            function changeTouchend(e) {
                e.preventDefault();
                layeredCanvasArea.dispatchEvent(new Event("click"));
            }
        }

        async function readImage() {
            var data =
                {
                    sinsakaiId: WebStorage.getItem("SinsakaiId"),
                    syuppinNo: WebStorage.getItem("SyuppinNo"),
                    saitensyaId: WebStorage.getItem("SaitensyaId")
                };

            $.ajax({
                type: "GET",
                url: "/Home/ReadImage",
                data: data
            })
            .then(
                function (result)
                {
                    image.src = result;
                },
                function (XMLHttpRequest, textStatus, errorThrown)
                {
                }
            );
        }

        async function uploadImage() {
            const dataUrl = context.canvas.toDataURL("image/png");
            var postData =
                {
                    sinsakaiId: WebStorage.getItem("SinsakaiId"),
                    syuppinNo: WebStorage.getItem("SyuppinNo"),
                    saitensyaId: WebStorage.getItem("SaitensyaId"),
                    data: dataUrl
                };

            $.ajax({
                type: "POST",
                url: "/Home/UploadImage",
                data: postData
            })
            .then(
                function (result)
                {
                },
                function (XMLHttpRequest, textStatus, errorThrown)
                {
                }
            );
        }

        async function getScore() {
            var data =
                {
                    sinsakaiId: WebStorage.getItem("SinsakaiId"),
                    syuppinNo: WebStorage.getItem("SyuppinNo"),
                    saitensyaId: WebStorage.getItem("SaitensyaId")
                };

            $.ajax({
                type: "GET",
                url: "/Home/GetScore",
                data: data
            })
            .then(
                function (result)
                {
                    scoreGenryou.value = result.scoreGenryou;
                    scoreKannouTokusei.value = result.scoreKannouTokusei;
                    scoreTyakusou.value = result.scoreTyakusou;
                    scoreGizyutu.value = result.scoreGizyutu;
                    scoreHousou.value = result.scoreHousou;
                    scoreTotal.value = result.scoreTotal;
                },
                function (XMLHttpRequest, textStatus, errorThrown)
                {
                }
            );
        }

        async function registScore() {
            var postData =
                {
                    sinsakaiId: WebStorage.getItem("SinsakaiId"),
                    syuppinNo: WebStorage.getItem("SyuppinNo"),
                    saitensyaId: WebStorage.getItem("SaitensyaId"),
                    scoreGenryou: scoreGenryou.value,
                    scoreKannouTokusei: scoreKannouTokusei.value,
                    scoreTyakusou: scoreTyakusou.value,
                    scoreGizyutu: scoreGizyutu.value,
                    scoreHousou: scoreHousou.value
                };

            $.ajax({
                type: "POST",
                url: "/Home/RegistScore",
                data: postData
            })
            .then(
                function (result)
                {
                },
                function (XMLHttpRequest, textStatus, errorThrown)
                {
                }
            );
        }

        var ModalTarget = {
            GENRYOU: '原料',
            KANNOU_TOKUSEI: '官能特性',
            TYAKUSOU: '着想',
            GIZYUTU: '技術',
            HOUSOU: '包装'
        };
    </script>
}
